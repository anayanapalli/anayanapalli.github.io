---
import PostList from "~/components/astro/post-list.astro"
import { common } from "~/config"
import MainLayout from "~/layouts/main.astro"
import { getPostsByLocale } from "~/utils"

// Use English posts only
const posts = await getPostsByLocale("en")

// Group posts by year
const postsByYear = posts.reduce(
  (acc: Record<string, any[]>, post: any) => {
    const year = new Date(post.data.pubDate).getFullYear().toString()
    if (!acc[year]) acc[year] = []
    acc[year].push(post)
    return acc
  },
  {} as Record<string, any[]>,
)

const years = Object.keys(postsByYear).sort((a, b) => Number(b) - Number(a))

// Fallback for pageMeta in case it's missing
const pageMeta = common.pageMeta?.archive ?? {
  title: "All Posts",
  description: "Here are all the posts",
  ogImage: "/images/page-meta/en/archive.png",
}
---

<MainLayout
  title={pageMeta.title}
  description={pageMeta.description}
  ogImage={pageMeta.ogImage}
>
  {
    years.map((year) => (
      <section class="year-group my-8">
        <h2 class="my-4 text-2xl font-bold">{year}</h2>
        {postsByYear[year].map((post: any) => (
          <PostList post={post} dateFormat="DD MMM" dateWidth="w-20" />
        ))}
      </section>
    ))
  }
</MainLayout>
